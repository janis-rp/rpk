# /docs/journal/2025-08-28.md

## Kopsavilkums
- **Mērķis:** atjaunot portāla autentifikāciju pēc datu bāzes pārbūves un sakārtot veco datu importu.
- **Rezultāts:** lietotāji atkal var reģistrēties un ielogoties (e‑pasts/Google/Facebook). Profili tiek veidoti `parent/{uid}`. Legacy dati ielādēti jaunā shēmā (`parent`/`child`).

## Kas izdarīts
1. **Firebase Web inicializācija**
   - Sakārtots `src/lib/firebase.js` un **eksportēts `app`**, `auth`, `db`, `storage`.
2. **Auth plūsma (frontend)**
   - Pievienota utilīte `ensureParentProfile(user)` → pirmajā loginā izveido `parent/{uid}` ar pamata laukiem.
   - `AuthContext` atjaunots: `onAuthStateChanged` → `ensureParentProfile` → lasa custom claims.
   - `ProtectedRoute`, `AdminRoute`, `RoleRedirect` — pasargi pret “tukšo ekrānu”, korekta pāradresācija.
   - `AuthPage` pārveidota ar precīzu kļūdu apstrādi un popup/redirect rezervi.
3. **Cloud Functions**
   - Izvietots **Gen1 (v1) `auth.user().onCreate`** (Node 18) → jauniem lietotājiem serveris automātiski izveido `parent/{uid}`.
   - Esošās v2 callable funkcijas saglabātas (`mergeParentData`, `adminUnlinkPhone`, `completeMerge`).
4. **Firestore**
   - **Rules** ieliktas/deployotas, lai lietotājs var rakstīt/lasīt **savu** `parent/{uid}` un `users/{uid}`; `child` redzams tikai vecākiem ar savu UID `parentIds`.
5. **Legacy datu imports**
   - Uzrakstīts un palaists `import-legacy-csv.cjs`:
     - `parent` (legacy) docID = tehnisks (`pk-…`, `ph-…`, `em-…`, `nm-…`), 
     - `child` docID = `cpk-…` vai `nm-vards-uzvards-yyyymmdd`.
     - `child.parentIds` = **docID**, nevis “Vārds Uzvārds”.
     - Legacy bērniem statuss `finished`.
   - Noturēta cilvēciski lasāma informācija (`fullName`, `parentNames`).
6. **Hosting**
   - `firebase deploy` — lapa atkal strādā.

## Zināmās nianses / atklātie jautājumi
- “Dzīvie” profili šobrīd arī atrodas **`parent`** kolekcijā. Ierosināts lauks **`kind`**: `profile` (dzīvie) vs `legacy` (vēsturiskie), bet vēl **nav** ieviests.
- Lomu sistēma nav pabeigta: nepieciešams admin rīks un callable `setUserRoles` + custom claims.
- Dublikātu pārbaude (e‑pasts/telefons pret legacy) — priekšlikums `checkLegacyDuplicates` (nav vēl ieviests).
- UI sākumlapa — minimālas dizaina izmaiņas, atgriezīsimies vēlāk.

## Nākamie soļi (to‑do)
- [ ] Ieviest `setUserRoles` (onCall) + Admin UI bloks lomām; noklusējuma loma `parent`.
- [ ] Pievienot laukus **`kind: "profile"`**, **`roles: ["parent"]`**, **`source: "auth"`** jaunajiem `parent/{uid}` (frontend utilītē vai onCreate).
- [ ] Ieviest `checkLegacyDuplicates` (onCall) + Admin “Dublikāti” skatu (`dedup` kolekcija).
- [ ] (Vienreiz) backfill skripts visiem esošajiem Auth lietotājiem → `parent/{uid}` (ja trūkst).
- [ ] “Mani bērni” blokā rādīt bērnus ar `parentIds` satur **UID** (attiecas uz jauno plūsmu).
- [ ] Piebilst `docs/` mapi repo un ielikt šos trīs failus.
