// rules_version = '2';
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function isAuthed() { return request.auth != null; }
    function isAdmin() { return request.auth.token.admin == true; }

    // Dzīvie profili — doc id = Auth UID
    match /parent/{uid} {
      allow read: if isAdmin() || (isAuthed() && request.auth.uid == uid);
      allow create, update: if isAuthed() && request.auth.uid == uid;
    }

    // Bērni: redz tikai tie vecāki, kuru UID ir parentIds
    match /child/{cid} {
      allow read: if isAdmin() || (isAuthed() && request.auth.uid in resource.data.parentIds);
      allow update: if isAdmin()
        || (isAuthed()
            && request.auth.uid in resource.data.parentIds
            && request.resource.data.parentIds == resource.data.parentIds);
      allow create, delete: if isAdmin();
    }

    // Pieteikumi (ja atgriezīsies nākotnē)
    match /applications/{aid} {
      allow read: if isAdmin() || (isAuthed() && request.auth.uid == resource.data.parentId);
      allow create, update, delete: if isAdmin()
        || (isAuthed() && request.resource.data.parentId == request.auth.uid);
    }
  }
}
